name: Build and Release Layer8 GUI

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0, v1.2.3, etc.

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build executable with PyInstaller
      run: |
        pyinstaller --name "Layer8-GUI" `
          --onefile `
          --windowed `
          --icon="Layer8/Media/Layer8-logo.ico" `
          --add-data "Layer8;Layer8" `
          --add-data "modern_theme.py;." `
          --add-data "db_connection.py;." `
          --add-data "config.py;." `
          --add-data "scanner_tools.py;." `
          --add-data "ai_analyzer.py;." `
          --add-data "updater.py;." `
          --hidden-import=PIL `
          --hidden-import=mysql.connector `
          --hidden-import=dotenv `
          --hidden-import=nacl `
          --hidden-import=argon2 `
          --hidden-import=anthropic `
          gui_app.pyw

    - name: Create version info
      run: |
        $version = "${{ github.ref_name }}".TrimStart('v')
        @{
          version = $version
          build_date = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
          commit = "${{ github.sha }}".Substring(0,7)
        } | ConvertTo-Json | Out-File -FilePath dist/version.json -Encoding UTF8

    - name: Package distribution
      run: |
        cd dist
        Compress-Archive -Path * -DestinationPath ../layer8-gui-windows.zip

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v3
      with:
        name: layer8-gui-windows
        path: layer8-gui-windows.zip

  build-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build executable with PyInstaller
      run: |
        pyinstaller --name "Layer8-GUI" \
          --onefile \
          --windowed \
          --add-data "Layer8:Layer8" \
          --add-data "modern_theme.py:." \
          --add-data "db_connection.py:." \
          --add-data "config.py:." \
          --add-data "scanner_tools.py:." \
          --add-data "ai_analyzer.py:." \
          --add-data "updater.py:." \
          --hidden-import=PIL \
          --hidden-import=mysql.connector \
          --hidden-import=dotenv \
          --hidden-import=nacl \
          --hidden-import=argon2 \
          --hidden-import=anthropic \
          gui_app.pyw

    - name: Create version info
      run: |
        version="${{ github.ref_name }}"
        version="${version#v}"
        echo "{\"version\":\"$version\",\"build_date\":\"$(date '+%Y-%m-%d %H:%M:%S')\",\"commit\":\"${GITHUB_SHA:0:7}\"}" > dist/version.json

    - name: Package distribution
      run: |
        cd dist
        zip -r ../layer8-gui-linux.zip *

    - name: Upload Linux artifact
      uses: actions/upload-artifact@v3
      with:
        name: layer8-gui-linux
        path: layer8-gui-linux.zip

  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build executable with PyInstaller
      run: |
        pyinstaller --name "Layer8-GUI" \
          --onefile \
          --windowed \
          --add-data "Layer8:Layer8" \
          --add-data "modern_theme.py:." \
          --add-data "db_connection.py:." \
          --add-data "config.py:." \
          --add-data "scanner_tools.py:." \
          --add-data "ai_analyzer.py:." \
          --add-data "updater.py:." \
          --hidden-import=PIL \
          --hidden-import=mysql.connector \
          --hidden-import=dotenv \
          --hidden-import=nacl \
          --hidden-import=argon2 \
          --hidden-import=anthropic \
          gui_app.pyw

    - name: Create version info
      run: |
        version="${{ github.ref_name }}"
        version="${version#v}"
        echo "{\"version\":\"$version\",\"build_date\":\"$(date '+%Y-%m-%d %H:%M:%S')\",\"commit\":\"${GITHUB_SHA:0:7}\"}" > dist/version.json

    - name: Package distribution
      run: |
        cd dist
        zip -r ../layer8-gui-macos.zip *

    - name: Upload macOS artifact
      uses: actions/upload-artifact@v3
      with:
        name: layer8-gui-macos
        path: layer8-gui-macos.zip

  create-release:
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Download all artifacts
      uses: actions/download-artifact@v3

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Layer8 GUI ${{ github.ref_name }}
        body: |
          ## Layer8 Security Platform ${{ github.ref_name }}

          ### What's New
          - See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details

          ### Downloads
          - **Windows**: Download `layer8-gui-windows.zip`
          - **Linux**: Download `layer8-gui-linux.zip`
          - **macOS**: Download `layer8-gui-macos.zip`

          ### Installation
          1. Download the appropriate file for your platform
          2. Extract the ZIP file
          3. Run the `Layer8-GUI` executable

          ### Auto-Update
          This release supports automatic updates. The application will check for new versions on startup.

          ### Requirements
          - MySQL database (optional for offline mode)
          - Internet connection for cloud features

          ---
          ðŸ¤– Built automatically with GitHub Actions
        draft: false
        prerelease: false

    - name: Upload Windows Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./layer8-gui-windows/layer8-gui-windows.zip
        asset_name: layer8-gui-windows.zip
        asset_content_type: application/zip

    - name: Upload Linux Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./layer8-gui-linux/layer8-gui-linux.zip
        asset_name: layer8-gui-linux.zip
        asset_content_type: application/zip

    - name: Upload macOS Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./layer8-gui-macos/layer8-gui-macos.zip
        asset_name: layer8-gui-macos.zip
        asset_content_type: application/zip
